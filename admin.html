<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ממשק מנהל – שיעורים</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.snow.css" rel="stylesheet">

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.min.js"></script>

<style>
#summary-editor { background: white; min-height: 100px; }
.lesson-item { margin: 5px 0; padding: 5px; border: 1px solid #ccc; }
button { margin-left: 5px; }
table { margin-top: 20px; border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
</style>
</head>
<body>

<a href="index.html" style="display:inline-block; margin:10px; padding:5px 10px; background:#A0522D; color:white; border-radius:5px; text-decoration:none; font-size:0.9em;">חזרה לאינדקס</a>

<h1>ממשק מנהל – שיעורים</h1>

<div id="login-section">
  <input type="email" id="email" placeholder="אימייל"><br>
  <input type="password" id="password" placeholder="סיסמה"><br>
  <button id="login-btn">התחבר</button>
  <div id="log"></div>
</div>

<button id="logout-btn" style="display:none;">התנתק</button>

<div id="admin-section" style="display:none;">
  <h2 id="form-title">הוסף שיעור חדש</h2>
  <input type="text" id="title" placeholder="שם השיעור"><br>
  <input type="text" id="rabbi" placeholder="שם הרב"><br>
  <input type="text" id="youtube" placeholder="קישור יוטיוב"><br>
  <select id="category">
    <option value="">לא סווג</option>
    <option value="הלכה">הלכה</option>
    <option value="אמונה">אמונה</option>
    <option value="היסטוריה">היסטוריה</option>
    <option value="פרשת השבוע">פרשת השבוע</option>
  </select><br>
  <div id="summary-editor"></div><br>
  <button id="add-lesson-btn">הוסף שיעור</button>

  <h2>שיעורים קיימים</h2>
  <div id="lessons-list"></div>

  <h2>סטטיסטיקות מכשירים</h2>
  <table>
    <thead>
      <tr>
        <th>מזהה מכשיר</th>
        <th>סוג מכשיר</th>
        <th>מספר כניסות</th>
        <th>כניסה אחרונה</th>
      </tr>
    </thead>
    <tbody id="device-table-body">
      <tr><td colspan="4">טוען...</td></tr>
    </tbody>
  </table>
</div>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyA9CHKDvVmhPSv6U2UpVj-QGyriF5QDjk0",
  authDomain: "har-habait-lessons.firebaseapp.com",
  projectId: "har-habait-lessons",
  storageBucket: "har-habait-lessons.appspot.com",
  messagingSenderId: "518010109655",
  appId: "1:518010109655:web:cd628123d6769aa87a7a92",
  measurementId: "G-RSNSTT3QL8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginSection = document.getElementById('login-section');
const adminSection = document.getElementById('admin-section');
const log = document.getElementById('log');

const quillAdd = new Quill('#summary-editor', { theme: 'snow' });

let allLessons = [];
let editingId = null; // מזהה השיעור שנערך

// --- התחברות ---
document.getElementById('login-btn').onclick = () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  log.innerHTML = "מנסה להתחבר...";
  auth.signInWithEmailAndPassword(email, password)
    .then(() => log.innerHTML = "התחברת בהצלחה!")
    .catch(err => log.innerHTML = "שגיאה בהתחברות: " + err.message);
};

// --- התנתקות ---
document.getElementById('logout-btn').onclick = () => {
  auth.signOut().then(() => location.reload());
};

// --- מעקב אחרי מצב התחברות ---
auth.onAuthStateChanged(user => {
  if(user){
    loginSection.style.display = 'none';
    adminSection.style.display = 'block';
    document.getElementById('logout-btn').style.display = 'inline-block';
    log.innerHTML = "מחובר כ: " + user.email;

    loadLessons();
    loadDeviceTable();  // טעינת הטבלה של המכשירים
  } else {
    loginSection.style.display = 'block';
    adminSection.style.display = 'none';
    document.getElementById('logout-btn').style.display = 'none';
    log.innerHTML = "";
  }
});

// --- פונקציות שיעורים ---
document.getElementById('add-lesson-btn').onclick = () => {
  const title = document.getElementById('title').value.trim();
  const rabbi = document.getElementById('rabbi').value.trim();
  const youtube = document.getElementById('youtube').value.trim();
  const category = document.getElementById('category').value;
  const summary = quillAdd.root.innerHTML;

  if(!title || !rabbi || !youtube){
    log.innerHTML = "אנא מלא את כל השדות!";
    return;
  }

  if(editingId){
    db.collection("lessons").doc(editingId).update({ title, rabbi, youtube, category, summary })
      .then(() => { log.innerHTML = "השיעור עודכן בהצלחה!"; resetForm(); })
      .catch(err => log.innerHTML = "שגיאה בעדכון: " + err.message);
  } else {
    db.collection("lessons").add({ title, rabbi, youtube, category, summary, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
      .then(() => { log.innerHTML = "השיעור נוסף בהצלחה!"; resetForm(); })
      .catch(err => log.innerHTML = "שגיאה בהוספה: " + err.message);
  }
};

function resetForm(){
  editingId = null;
  document.getElementById('title').value = "";
  document.getElementById('rabbi').value = "";
  document.getElementById('youtube').value = "";
  document.getElementById('category').value = "";
  quillAdd.root.innerHTML = "";
  document.getElementById('form-title').innerText = "הוסף שיעור חדש";
  document.getElementById('add-lesson-btn').innerText = "הוסף שיעור";
}

function loadLessons(){
  db.collection("lessons").orderBy("timestamp","desc").onSnapshot(snapshot => {
    allLessons = [];
    const list = document.getElementById('lessons-list');
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      data.id = doc.id;
      allLessons.push(data);
      const dateStr = data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleDateString('he-IL') : 'לא זמין';
      const div = document.createElement('div');
      div.className = 'lesson-item';
      div.innerHTML = `
        ${data.title} - ${data.rabbi} [${data.category || "לא סווג"}] - ${dateStr}
        <button onclick="editLesson('${doc.id}')">ערוך</button>
        <button onclick="deleteLesson('${doc.id}')">מחק</button>
      `;
      list.appendChild(div);
    });
  });
}

window.deleteLesson = function(id){
  db.collection("lessons").doc(id).delete()
    .then(() => log.innerHTML = "השיעור נמחק בהצלחה!")
    .catch(err => log.innerHTML = "שגיאה במחיקה: " + err.message);
};

window.editLesson = function(id){
  const lesson = allLessons.find(l => l.id === id);
  if(!lesson) return;
  editingId = id;
  document.getElementById('title').value = lesson.title;
  document.getElementById('rabbi').value = lesson.rabbi;
  document.getElementById('youtube').value = lesson.youtube;
  document.getElementById('category').value = lesson.category || "";
  quillAdd.root.innerHTML = lesson.summary || "";
  document.getElementById('form-title').innerText = "עריכת שיעור";
  document.getElementById('add-lesson-btn').innerText = "שמור שינויים";
};

// --- פונקציית טבלת מכשירים ---
function loadDeviceTable(){
  const tbody = document.getElementById("device-table-body");
  db.collection("siteStats").doc("visits").collection("devices")
    .onSnapshot(snapshot => {
      tbody.innerHTML = '';
      if(snapshot.empty){
        tbody.innerHTML = '<tr><td colspan="4">לא נמצאו נתונים</td></tr>';
        return;
      }
      snapshot.forEach(doc => {
        const data = doc.data();
        const lastVisit = data.lastVisit?.toDate ? data.lastVisit.toDate().toLocaleString('he-IL') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${data.deviceType || ''}</td>
          <td>${data.count || 0}</td>
          <td>${lastVisit}</td>
        `;
        tbody.appendChild(tr);
      });
    }, err => {
      tbody.innerHTML = `<tr><td colspan="4">שגיאה בטעינת הנתונים: ${err.message}</td></tr>`;
    });
}
</script>

</body>
</html>
