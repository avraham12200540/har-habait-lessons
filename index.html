<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>מרכז שיעורי הר הבית</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<!-- סמלילים -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

<style>
/* רקע כללי */
.background-image {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: url('1.png') center center / cover no-repeat;
  opacity: 0.3; z-index: -1;
}

/* סיכומים וכפתורים */
.modal-content--summary { max-height: 80vh; overflow:auto; }
.summary-btn {
  background: #ff9800; color: #fff; border: none;
  padding: 6px 10px; border-radius: 6px; cursor: pointer;
  font-size: 0.9em; margin-top: 6px;
}
.summary-btn:hover { background:#e68900; }
.lesson-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }

/* מודאל */
.modal {
  display: none;
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  justify-content: center; align-items: center;
  z-index: 1000;
}
.modal.show { display: flex; }

.modal-content {
  position: relative;
  background: #fff;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  overflow:auto;
  border-radius: 8px;
}

/* כפתור סגירה מינימלי */
.modal-close {
  font-size: 1.2rem;
  color: #555;
  background: transparent;
  border: none;
  cursor: pointer;
  position: absolute;
  top: 8px;
  right: 8px;
  line-height: 1;
}
.modal-close:hover { color: #000; }
</style>
</head>
<body>

<div class="background-image"></div>

<header>
  <h1>מרכז שיעורי הר הבית</h1>
  <a href="admin.html" class="admin-link">כניסת מנהל</a>
</header>

<div style="display:flex; gap:10px; margin-bottom:20px; padding:0 10px;">
  <input type="text" id="search" placeholder="חפש לפי שם שיעור או שם הרב..." style="flex:1;">
  <select id="sort-select">
    <option value="date">מיון לפי תאריך</option>
    <option value="title">מיון לפי שם השיעור</option>
  </select>
  <select id="category-select">
    <option value="">כל הקטגוריות</option>
    <option value="הלכה">הלכה</option>
    <option value="היסטוריה">היסטוריה</option>
    <option value="פרשת השבוע">פרשת השבוע</option>
  </select>
</div>

<main id="lessons-container"></main>

<!-- מודאל וידאו -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button id="close-modal" class="modal-close" aria-label="סגור">×</button>
    <iframe id="modal-video" width="100%" height="450" frameborder="0" allowfullscreen></iframe>
  </div>
</div>

<!-- מודאל סיכום -->
<div id="summary-modal" class="modal" aria-hidden="true">
  <div class="modal-content modal-content--summary">
    <button id="close-summary-modal" class="modal-close" aria-label="סגור">×</button>
    <div id="summary-content"></div>
  </div>
</div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyA9CHKDvVmhPSv6U2UpVj-QGyriF5QDjk0",
  authDomain: "har-habait-lessons.firebaseapp.com",
  projectId: "har-habait-lessons",
  storageBucket: "har-habait-lessons.appspot.com",
  messagingSenderId: "518010109655",
  appId: "1:518010109655:web:cd628123d6769aa87a7a92",
  measurementId: "G-RSNSTT3QL8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* Elements */
const container = document.getElementById('lessons-container');
const modal = document.getElementById('modal');
const modalVideo = document.getElementById('modal-video');
const closeModal = document.getElementById('close-modal');

const summaryModal = document.getElementById('summary-modal');
const summaryContent = document.getElementById('summary-content');
const closeSummaryModal = document.getElementById('close-summary-modal');

function getYouTubeId(url) {
  const regExp = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|watch\?.+&v=)([^#\&\?]{11}).*/;
  const match = url?.match(regExp);
  return (match && match[1]) ? match[1] : null;
}
function normalizeText(str) { return str ? str.trim().toLowerCase() : ""; }

let allLessons = [];

/* Load lessons */
db.collection("lessons").onSnapshot(snapshot => {
  allLessons = [];
  snapshot.forEach(doc => {
    const data = doc.data();
    data.id = doc.id;
    allLessons.push(data);
  });
  filterAndSortLessons();
});

function renderLessons(lessons) {
  container.innerHTML = '';
  lessons.forEach(data => {
    const videoID = getYouTubeId(data.youtube);
    let dateStr = "לא זמין";
    if (data.timestamp?.toDate) {
      const date = data.timestamp.toDate();
      dateStr = date.toLocaleDateString('he-IL', { year:'numeric', month:'long', day:'numeric' });
    } else if (data.timestamp?.seconds) {
      const date = new Date(data.timestamp.seconds * 1000);
      dateStr = date.toLocaleDateString('he-IL', { year:'numeric', month:'long', day:'numeric' });
    }

    const lessonDiv = document.createElement('div');
    lessonDiv.className = 'lesson-card';
    lessonDiv.dataset.id = data.id;

    lessonDiv.innerHTML = `
      <img src="${videoID ? `https://img.youtube.com/vi/${videoID}/hqdefault.jpg` : 'https://via.placeholder.com/320x180?text=No+Image'}" alt="${data.title || ""}">
      <div class="lesson-meta">
        <h3>${data.title || ""}</h3>
        <p><strong>הרב:</strong> ${data.rabbi || ""}</p>
        <p><strong>קטגוריה:</strong> ${data.category || "לא סווג"}</p>
        <p><strong>תאריך:</strong> ${dateStr}</p>
        <div class="lesson-actions">
          ${videoID ? `<button class="watch-btn" data-id="${data.id}">צפייה</button>` : ""}
          ${data.summary ? `<button class="summary-btn" data-id="${data.id}">הצגת סיכום</button>` : ""}
        </div>
      </div>
    `;
    container.appendChild(lessonDiv);
  });
}

/* Delegated clicks for buttons */
container.addEventListener('click', (e) => {
  const id = e.target.dataset?.id;

  if (e.target.classList.contains('watch-btn')) {
    e.stopPropagation();
    const lesson = allLessons.find(l => l.id === id);
    const videoID = getYouTubeId(lesson?.youtube);
    if (videoID) {
      modalVideo.src = `https://www.youtube.com/embed/${videoID}`;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }
  }

  if (e.target.classList.contains('summary-btn')) {
    e.stopPropagation();
    const lesson = allLessons.find(l => l.id === id);
    if (lesson?.summary) {
      summaryContent.innerHTML = lesson.summary;
      summaryModal.classList.add('show');
      summaryModal.setAttribute('aria-hidden', 'false');
    }
  }
});

/* Clicking a whole card opens the video (אם יש), אבל לא אם לחיצה על כפתור */
container.addEventListener('click', (e) => {
  if (e.target.closest('button')) return;
  const card = e.target.closest('.lesson-card');
  if (!card) return;
  const lesson = allLessons.find(l => l.id === card.dataset.id);
  const videoID = getYouTubeId(lesson?.youtube);
  if (videoID) {
    modalVideo.src = `https://www.youtube.com/embed/${videoID}`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
  }
});

function filterAndSortLessons() {
  const searchTerm = normalizeText(searchInput.value);
  const category = categorySelect.value;
  const sortType = sortSelect.value;

  let filtered = allLessons.filter(l => {
    const matchesSearch = normalizeText(l.title).includes(searchTerm) || normalizeText(l.rabbi).includes(searchTerm);
    const matchesCategory = category ? l.category === category : true;
    return matchesSearch && matchesCategory;
  });

  if (sortType === 'title') filtered.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
  else if (sortType === 'date') filtered.sort((a,b)=> (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

  renderLessons(filtered);
}

/* Inputs */
const searchInput = document.getElementById('search');
const sortSelect = document.getElementById('sort-select');
const categorySelect = document.getElementById('category-select');

searchInput.addEventListener('input', filterAndSortLessons);
sortSelect.addEventListener('change', filterAndSortLessons);
categorySelect.addEventListener('change', filterAndSortLessons);

/* Modal close */
closeModal.addEventListener('click', () => {
  modalVideo.src = '';
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
});
closeSummaryModal.addEventListener('click', () => {
  summaryModal.classList.remove('show');
  summaryModal.setAttribute('aria-hidden', 'true');
});

/* Click outside content closes */
modal.addEventListener('click', (e) => { if (e.target===modal){ modalVideo.src=''; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }});
summaryModal.addEventListener('click', (e) => { if (e.target===summaryModal){ summaryModal.classList.remove('show'); summaryModal.setAttribute('aria-hidden','true'); }});
</script>

</body>
</html>
