<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מרכז שיעורי הר הבית</title>
  <style>
    /* פשוט, נקי ו-RTL */
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#9aa4b2;--text:#eef2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans Hebrew","Arial",sans-serif;background:linear-gradient(180deg,#071124 0%, #0b1220 100%);color:var(--text);min-height:100vh}
    .container{max-width:1000px;margin:24px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{margin:0;font-size:24px}
    nav{display:flex;gap:12px}
    a.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--text);text-decoration:none}
    .searchbar{display:flex;gap:8px;align-items:center}
    input[type=text],select,textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .meta{color:var(--muted);font-size:13px;margin-top:8px}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:12px;margin-left:6px}
    main{min-height:60vh}
    .detail video,.detail audio{width:100%;border-radius:8px}
    footer{opacity:0.8;margin-top:28px;color:var(--muted);font-size:13px}
    /* Responsive */
    @media(max-width:600px){h1{font-size:18px}}
    /* Admin panel */
    .admin-panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .hidden{display:none}
    .tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .btn-primary{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none}
    .link{color:var(--accent);cursor:pointer;text-decoration:underline}
    /* Small helpers */
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>מרכז שיעורי הר הבית</h1>
        <div style="color:var(--muted);font-size:13px">אוספים שיעורים עיוניים והלכתיים על ענייני הר הבית</div>
      </div>
      <nav>
        <a class="btn" href="#/">דף הבית</a>
        <a class="btn" href="#/lessons">השיעורים</a>
        <a class="btn" href="#/about">אודות</a>
        <a id="adminLink" class="btn" href="#/admin">מנהל</a>
      </nav>
    </header>

    <main id="app">
      <!-- דפי SPA נטענים לכאן -->
    </main>

    <footer>
      &copy; מרכז שיעורי הר הבית — אתר לדוגמה. אם תרצה אעזור לפרוס ל־Firebase Hosting.
    </footer>
  </div>

  <!-- תבניות דפים -->
  <template id="homeTpl">
    <div class="card">
      <h2>ברוכים הבאים</h2>
      <p style="color:var(--muted)">כאן תוכלו למצוא שיעורים של רבנים בנושא ההר, מסודרים לפי נושא, רב ותאריך. השתמשו בכפתור "השיעורים" כדי להתחיל.</p>
      <div style="margin-top:12px">
        <a class="btn-primary" href="#/lessons">לרשימת השיעורים</a>
      </div>
    </div>
  </template>

  <template id="lessonsTpl">
    <div>
      <div class="row" style="justify-content:space-between;margin-bottom:12px">
        <div class="searchbar">
          <input id="qInput" type="text" placeholder="חיפוש כותרת / תקציר..." />
          <select id="filterRabbi"><option value="">כל הרבנים</option></select>
          <select id="filterTopic"><option value="">כל הנושאים</option></select>
          <button id="searchBtn" class="btn">חפש</button>
        </div>
      </div>
      <div id="lessonsGrid" class="grid"></div>
    </div>
  </template>

  <template id="lessonDetailTpl">
    <div class="card detail">
      <h2 id="lessonTitle"></h2>
      <div class="meta"><span id="lessonRabbi"></span> • <span id="lessonDate"></span> • <span id="lessonTopic"></span></div>
      <div id="mediaContainer" style="margin-top:12px"></div>
      <div style="margin-top:12px" id="lessonSummary"></div>
      <div style="margin-top:12px;color:var(--muted);font-size:13px">מקור: <span id="lessonSource"></span></div>
    </div>
  </template>

  <template id="aboutTpl">
    <div class="card">
      <h2>אודות</h2>
      <p style="color:var(--muted)">אתר לדוגמה שמרכז שיעורים בנושא הר הבית. ניתן להרחיב, להוסיף הרשאות, ולפרוס ב־Firebase Hosting.</p>
    </div>
  </template>

  <template id="adminTpl">
    <div>
      <div id="authBox" class="card admin-panel">
        <h3>כניסה למנהל</h3>
        <div id="authForm">
          <div style="margin-top:6px"><input id="adminEmail" type="text" placeholder="אימייל מנהל" /></div>
          <div style="margin-top:6px"><input id="adminPass" type="password" placeholder="סיסמה" /></div>
          <div style="margin-top:8px"><button id="loginBtn" class="btn-primary">התחבר</button></div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px">ניתן ליצור משתמש דרך קונסול Firebase או לאפשר הרשמה.</div>
        </div>
        <div id="authState" class="hidden" style="margin-top:10px">
          <div id="who" style="margin-bottom:8px"></div>
          <button id="logoutBtn" class="btn">התנתק</button>
        </div>
      </div>

      <div id="uploader" class="card admin-panel hidden" style="margin-top:12px">
        <h3>הוספת שיעור חדש</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="inpTitle" placeholder="כותרת השיעור" />
          <input id="inpRabbi" placeholder="שם הרב" />
          <input id="inpTopic" placeholder="נושא" />
          <input id="inpDate" type="date" />
          <textarea id="inpSummary" rows="4" placeholder="תקציר / סיכום"></textarea>
          <input id="inpMediaFile" type="file" />
          <input id="inpSource" placeholder="קישור מקור (אופציונלי)" />
          <div style="display:flex;gap:8px">
            <button id="uploadBtn" class="btn-primary">הוסף שיעור</button>
          </div>
        </div>
        <div id="uploadStatus" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </div>
  </template>

  <!-- ספריות Firebase (compat פשוט להטמעה מהירה) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    /***** CONFIG: החלף את הערכים שלמטה בערכי הפרויקט שלך ב־Firebase *****/
   const firebaseConfig = {
    apiKey: "AIzaSyA9CHKDvVmhPSv6U2UpVj-QGyriF5QDjk0",
    authDomain: "har-habait-lessons.firebaseapp.com",
    projectId: "har-habait-lessons",
    storageBucket: "har-habait-lessons.firebasestorage.app",
    messagingSenderId: "518010109655",
    appId: "1:518010109655:web:cd628123d6769aa87a7a92",
    measurementId: "G-RSNSTT3QL8"
  };
    /***** סוף קונפיג *****/

    // אתחול
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // גלובלים
    const app = document.getElementById('app');

    // SPA - רוטינג פשוט
    function router(){
      const hash = location.hash || '#/';
      if(hash.startsWith('#/lessons')) renderLessons();
      else if(hash.startsWith('#/lesson/')){
        const id = hash.split('/')[2]; renderLessonDetail(id);
      }
      else if(hash.startsWith('#/admin')) renderAdmin();
      else if(hash.startsWith('#/about')) renderTemplate('aboutTpl');
      else renderTemplate('homeTpl');
    }

    window.addEventListener('hashchange',router);
    document.addEventListener('DOMContentLoaded',router);

    function renderTemplate(id){
      const tpl = document.getElementById(id);
      app.innerHTML = '';
      app.appendChild(tpl.content.cloneNode(true));
    }

    /* --- דף רשימת שיעורים --- */
    async function renderLessons(){
      renderTemplate('lessonsTpl');
      const grid = document.getElementById('lessonsGrid');
      const qInput = document.getElementById('qInput');
      const searchBtn = document.getElementById('searchBtn');
      const filterRabbi = document.getElementById('filterRabbi');
      const filterTopic = document.getElementById('filterTopic');

      // טען את כל השיעורים
      const snapshot = await db.collection('lessons').orderBy('date','desc').get();
      const lessons = snapshot.docs.map(d=>({id:d.id,...d.data()}));

      // מלא פילטרים
      const rabbis = Array.from(new Set(lessons.map(l=>l.rabbi||'לא ידוע'))).sort();
      const topics = Array.from(new Set(lessons.map(l=>l.topic||'כללי'))).sort();
      rabbis.forEach(r=>{ const opt=document.createElement('option'); opt.value=r; opt.textContent=r; filterRabbi.appendChild(opt);});
      topics.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; filterTopic.appendChild(opt);});

      function renderList(list){
        grid.innerHTML='';
        if(list.length===0) grid.innerHTML = '<div style="color:var(--muted)">לא נמצאו שיעורים.</div>';
        list.forEach(lesson=>{
          const div=document.createElement('div'); div.className='card';
          div.innerHTML = `<h3 style="margin:0">${escapeHtml(lesson.title)}</h3>
            <div class="meta">${escapeHtml(lesson.rabbi||'—')} • ${formatDate(lesson.date)} <span class="chip">${escapeHtml(lesson.topic||'—')}</span></div>
            <div style="margin-top:8px;color:var(--muted);font-size:14px">${escapeHtml(lesson.summary?lesson.summary.slice(0,160):'')}</div>
            <div style="margin-top:10px"><a class="btn" href="#/lesson/${lesson.id}">פתח שיעור</a></div>`;
          grid.appendChild(div);
        });
      }

      renderList(lessons);

      searchBtn.addEventListener('click',()=>{
        const q = qInput.value.trim();
        const r = filterRabbi.value; const t = filterTopic.value;
        let filtered = lessons.filter(l=>{
          const matchesQ = q===''?true:( (l.title||'').includes(q) || (l.summary||'').includes(q) );
          const matchesR = r? (l.rabbi===r) : true;
          const matchesT = t? (l.topic===t) : true;
          return matchesQ && matchesR && matchesT;
        });
        renderList(filtered);
      });
    }

    /* --- דף פרטי שיעור --- */
    async function renderLessonDetail(id){
      renderTemplate('lessonDetailTpl');
      const titleEl = document.getElementById('lessonTitle');
      const rabbiEl = document.getElementById('lessonRabbi');
      const dateEl = document.getElementById('lessonDate');
      const topicEl = document.getElementById('lessonTopic');
      const mediaContainer = document.getElementById('mediaContainer');
      const summaryEl = document.getElementById('lessonSummary');
      const sourceEl = document.getElementById('lessonSource');

      const doc = await db.collection('lessons').doc(id).get();
      if(!doc.exists){ app.innerHTML='<div class="card">שיעור לא נמצא.</div>'; return; }
      const lesson = doc.data();
      titleEl.textContent = lesson.title || '—';
      rabbiEl.textContent = lesson.rabbi || '—';
      dateEl.textContent = formatDate(lesson.date);
      topicEl.textContent = lesson.topic || '—';
      summaryEl.textContent = lesson.summary || '';
      sourceEl.textContent = lesson.source || '';

      // הצג מדיה: אם יש videoUrl -> embed, אם יש audioUrl -> audio tag, אם יש storagePath -> הורד URL
      mediaContainer.innerHTML = '';
      if(lesson.videoUrl && lesson.videoUrl.includes('youtube')){
        // הפשטה: קישור יוטיוב פשוט
        const iframe = document.createElement('iframe'); iframe.width='100%'; iframe.height='360'; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true;
        // נסה להמיר ל־embed
        const videoId = extractYouTubeID(lesson.videoUrl);
        iframe.src = 'https://www.youtube.com/embed/' + videoId;
        mediaContainer.appendChild(iframe);
      } else if(lesson.videoUrl){
        const v = document.createElement('video'); v.controls=true; v.src = lesson.videoUrl; mediaContainer.appendChild(v);
      } else if(lesson.audioUrl){
        const a = document.createElement('audio'); a.controls=true; a.src=lesson.audioUrl; mediaContainer.appendChild(a);
      } else if(lesson.storagePath){
        // הורד URL מאחסון
        const ref = storage.ref(lesson.storagePath);
        try{
          const url = await ref.getDownloadURL();
          if(url.match(/\.(mp4|webm|ogg)$/i)){
            const v=document.createElement('video'); v.controls=true; v.src=url; mediaContainer.appendChild(v);
          } else if(url.match(/\.(mp3|wav|m4a)$/i)){
            const a=document.createElement('audio'); a.controls=true; a.src=url; mediaContainer.appendChild(a);
          } else {
            const a=document.createElement('a'); a.href=url; a.textContent='הורדת קובץ המדיה'; a.target='_blank'; mediaContainer.appendChild(a);
          }
        }catch(e){ console.error(e); }
      }
    }

    /* --- דף מנהל --- */
    function renderAdmin(){
      renderTemplate('adminTpl');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const who = document.getElementById('who');
      const authState = document.getElementById('authState');
      const authBox = document.getElementById('authBox');
      const uploader = document.getElementById('uploader');
      const uploadBtn = document.getElementById('uploadBtn');
      const uploadStatus = document.getElementById('uploadStatus');

      auth.onAuthStateChanged(user=>{
        if(user){
          who.textContent = 'מנהל מחובר: ' + user.email;
          authState.classList.remove('hidden');
          document.getElementById('authForm').classList.add('hidden');
          uploader.classList.remove('hidden');
        }else{
          who.textContent='';
          authState.classList.add('hidden');
          document.getElementById('authForm').classList.remove('hidden');
          uploader.classList.add('hidden');
        }
      });

      loginBtn.addEventListener('click',()=>{
        const email = document.getElementById('adminEmail').value;
        const pass = document.getElementById('adminPass').value;
        auth.signInWithEmailAndPassword(email,pass).catch(e=>{
          alert('שגיאה בהתחברות: '+e.message);
        });
      });

      logoutBtn.addEventListener('click',()=>auth.signOut());

      uploadBtn.addEventListener('click',async ()=>{
        const title = document.getElementById('inpTitle').value.trim();
        const rabbi = document.getElementById('inpRabbi').value.trim();
        const topic = document.getElementById('inpTopic').value.trim();
        const dateVal = document.getElementById('inpDate').value;
        const summary = document.getElementById('inpSummary').value.trim();
        const file = document.getElementById('inpMediaFile').files[0];
        const source = document.getElementById('inpSource').value.trim();

        if(!title){ alert('אנא מלא כותרת.'); return; }
        uploadStatus.textContent = 'שומר...';

        let storagePath = null;
        let downloadUrl = null;
        if(file){
          const path = 'lessons_media/'+Date.now()+'_'+file.name;
          const ref = storage.ref(path);
          try{
            const snap = await ref.put(file);
            downloadUrl = await ref.getDownloadURL();
            storagePath = path;
          }catch(e){ alert('שגיאה בהעלאת הקובץ: '+e.message); uploadStatus.textContent=''; return; }
        }

        // תאריך
        let dateObj = null;
        if(dateVal) dateObj = new Date(dateVal);
        else dateObj = new Date();

        const doc = {
          title, rabbi, topic, summary, source,
          date: firebase.firestore.Timestamp.fromDate(dateObj),
          storagePath: storagePath || null,
          videoUrl: (downloadUrl && downloadUrl.match(/\.(mp4|webm|ogg)$/i))?downloadUrl:null,
          audioUrl: (downloadUrl && downloadUrl.match(/\.(mp3|wav|m4a)$/i))?downloadUrl:null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try{
          await db.collection('lessons').add(doc);
          uploadStatus.textContent = 'הוספתי את השיעור בהצלחה.';
          setTimeout(()=>location.hash='#/lessons',800);
        }catch(e){ alert('שגיאה בשמירה: '+e.message); uploadStatus.textContent=''; }
      });
    }

    /* --- כלים --- */
    function formatDate(timestamp){
      if(!timestamp) return '-';
      // יכול להיות Timestamp או string
      let d;
      if(timestamp && timestamp.toDate) d = timestamp.toDate();
      else d = new Date(timestamp);
      return d.toLocaleDateString('he-IL',{year:'numeric',month:'short',day:'numeric'});
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];}); }

    function extractYouTubeID(url){
      if(!url) return '';
      const m = url.match(/[?&]v=([^&]+)/) || url.match(/youtu\.be\/([^?&]+)/) || url.match(/embed\/([^?&]+)/);
      return m?m[1]:url;
    }

    // עזרה למשתמש: קישור מנהל בתפריט
    document.getElementById('adminLink').addEventListener('click',()=>{ location.hash='#/admin'; });

  </script>

  <!-- הוראות פריסה קצרות -->
  <!--
    הוראות מהירות:
    1. צרף את קובץ זה כ־index.html
    2. צור פרוייקט ב־Firebase, העתק את קונפיג במקום המתאים מ־Firebase Console
    3. ב־Firestore צור אוסף בשם "lessons" (אפשר לשנות בקוד)
    4. ב־Storage אפשר לשמור קבצי מדיה; הקפד להגדיר כללי אבטחה מתאימים (ראו הערות למטה)
    5. לפרוס מהר: השתמש ב־Firebase Hosting (מדריכים ב־console)

    דגשים לאבטחה:
    - הגדר כללי Firestore ו־Storage כך שרק משתמשים מאומתים (או קבוצת מנהלים) יוכלו לכתוב.
    - דוגמא לכלל Firestore פשוט (רק למנהלים):
      match /databases/{database}/documents {
        match /lessons/{docId} {
          allow read: if true;
          allow write: if request.auth != null && request.auth.token.email == 'you@domain.com';
        }
      }
    - אל תשאיר כללים פתוחים לפרודקשן.
  -->
</body>
</html>
