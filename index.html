<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>מרכז שיעורי הר הבית</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<style>
.background-image {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: url('1.png') center center / cover no-repeat;
  opacity: 0.3; z-index: -1;
}
.modal-content--summary { max-height: 80vh; overflow:auto; }
.summary-btn { background:#ff9800; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:0.9em; margin-top:6px; }
.summary-btn:hover { background:#e68900; }
.lesson-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal.show { display:flex; }
.modal-content { position:relative; background:#fff; padding:20px; max-width:90%; max-height:90%; overflow:auto; border-radius:8px; }
.modal-close { font-size:1.2rem; color:#555; background:transparent; border:none; cursor:pointer; position:absolute; top:8px; right:8px; line-height:1; }
.modal-close:hover { color:#000; }
</style>
</head>
<body>

<div class="background-image"></div>

<!-- ב־<head> של הדף -->
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<header>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <img src="logo.png" alt="לוגו האתר" class="site-logo">
  <h1>מרכז שיעורי הר הבית</h1>
  <a href="admin.html" class="admin-link">כניסת מנהל</a>
</header>

<style>
/* סגנון ל־header */
header {
  position: sticky; /*הכותרת לא תישאר במקומה הרגיל */
  background: #CD853F; /* צבע חום */
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 20px; /* padding ימין ושמאל אחיד */
  box-sizing: border-box;
}

/* סגנון ללוגו */
.site-logo {
  height: 90px;
  width: auto;
}

/* סגנון לכותרת */
h1 {
  font-family: 'Great Vibes', cursive; /* פונט קליגרפי */
  font-size: 60px;
  margin: 0;
  padding-left: 511px; /* אפשר לשנות למיקום הרצוי */
  white-space: nowrap; /* מונע שבירה לשורה חדשה */
}

/* סגנון לקישור מנהל */
.admin-link {
  color: white;
  text-decoration: none;
}

/* רספונסיביות בסיסית למסכים קטנים */
@media (max-width: 1200px) {
  h1 {
    font-size: 60px;
    padding-left: 300px;
  }
}

@media (max-width: 800px) {
  h1 {
    font-size: 40px;
    padding-left: 100px;
  }
}
</style>

<div class="search-background">
  <div class="search-container">
    <input type="text" id="search" placeholder="חפש לפי נושא, שם שיעור או שם הרב...">
  </div>
</div>

<style>
/* רקע חום מלא רוחב המסך שמאחורי התיבה */
.search-background {
  background-color: #CD853F;
  padding-top: 6px;
  padding-bottom: 6px;
  padding-left: 10px;  /* רווח מימין */
  padding-right: 550px; /* רווח משמאל */
  
  width: 100%;
  top: 20px;
  z-index: 100;
}

/* המיכל של התיבה */
.search-container {
  width: 100%;
  max-width: 600px; /* רוחב מקסימלי */
}

/* תיבת החיפוש */
.search-container input {
  width: 100%;
  height: 40px;
  font-size: 18px;
  padding: 0 10px;
  box-sizing: border-box;
}
</style>









<div
<div style="display:flex; gap:10px; margin-bottom:20px; padding:0 10px; padding-top: 5px;">
  <select id="category-select">
    <option value="">כל הקטגוריות</option>
    <option value="הלכה">הלכה</option>
    <option value="היסטוריה">היסטוריה</option>
    <option value="פרשת השבוע">פרשת השבוע</option>
  </select>
</div>

<main id="lessons-container"></main>

<!-- מודאל וידאו -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button id="close-modal" class="modal-close" aria-label="סגור">×</button>
    <iframe id="modal-video" width="100%" height="450" frameborder="0" allowfullscreen></iframe>
  </div>
</div>

<!-- מודאל סיכום -->
<div id="summary-modal" class="modal" aria-hidden="true">
  <div class="modal-content modal-content--summary">
    <button id="close-summary-modal" class="modal-close" aria-label="סגור">×</button>
    <div id="summary-content"></div>
  </div>
</div>

<script>
/* === Firebase config (ללא שינוי) === */
const firebaseConfig = {
  apiKey: "AIzaSyA9CHKDvVmhPSv6U2UpVj-QGyriF5QDjk0",
  authDomain: "har-habait-lessons.firebaseapp.com",
  projectId: "har-habait-lessons",
  storageBucket: "har-habait-lessons.appspot.com",
  messagingSenderId: "518010109655",
  appId: "1:518010109655:web:cd628123d6769aa87a7a92",
  measurementId: "G-RSNSTT3QL8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* === אלמנטים מהדף (מוקדם כדי שלא תהיה בעיית טעינה) === */
const container = document.getElementById('lessons-container');
const searchInput = document.getElementById('search');
const categorySelect = document.getElementById('category-select');

const modal = document.getElementById('modal');
const modalVideo = document.getElementById('modal-video');
const closeModal = document.getElementById('close-modal');
const summaryModal = document.getElementById('summary-modal');
const summaryContent = document.getElementById('summary-content');
const closeSummaryModal = document.getElementById('close-summary-modal');

/* === פונקציות עזר קצרות === */
function getYouTubeId(url) {
  const regExp = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|watch\?.+&v=)([^#\&\?]{11}).*/;
  const match = url?.match(regExp);
  return (match && match[1]) ? match[1] : null;
}

/* מסיר ניקוד, סימני פיסוק מיותרים ורווחים כפולים – כדי לשפר חיפוש בעברית */
function normalizeHebrewBasic(str) {
  if (!str) return "";
  return String(str)
    .normalize("NFKD")
    .replace(/[\u0591-\u05C7]/g, "")         // ניקוד וטעמי מקרא
    .replace(/<[^>]+>/g, " ")                 // הסרת תגיות HTML אם יש בסיכום
    .replace(/[\"'’”“.,!?()\-–—:;[\]{}]/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();
}

/* === נתונים מהפיירבייס + Fuse (המנוע חיפוש) === */
let allLessons = [];
let fuse = null;

db.collection("lessons").onSnapshot(snapshot => {
  const arr = [];
  snapshot.forEach(doc => {
    const d = doc.data();
    d.id = doc.id;

    // שדות "מנורמלים" לצורך חיפוש חכם
    d.titleNorm   = normalizeHebrewBasic(d.title);
    d.rabbiNorm   = normalizeHebrewBasic(d.rabbi);
    d.categoryNorm= normalizeHebrewBasic(d.category);
    d.summaryNorm = normalizeHebrewBasic(d.summary);

    arr.push(d);
  });

  allLessons = arr;

  // יצירת אינדקס לחיפוש חכם
  fuse = new Fuse(allLessons, {
    keys: [
      { name: 'titleNorm',    weight: 0.5 },
      { name: 'summaryNorm',  weight: 0.6 },
      { name: 'rabbiNorm',    weight: 0.4 },
      { name: 'categoryNorm', weight: 0.2 },
    ],
    includeScore: true,
    threshold: 0.35,        // כמה "סלחני" לשגיאות (קטן=קשיח, גדול=סלחני)
    ignoreLocation: true,
    minMatchCharLength: 2
  });

  filterAndSortLessons();
});

/* === ציור הכרטיסים === */
function renderLessons(lessons) {
  container.innerHTML = '';
  lessons.forEach(data => {
    const videoID = getYouTubeId(data.youtube);
    let dateStr = "לא זמין";
    if (data.timestamp?.toDate) {
      dateStr = data.timestamp.toDate().toLocaleDateString('he-IL', { year:'numeric', month:'long', day:'numeric' });
    } else if (data.timestamp?.seconds) {
      dateStr = new Date(data.timestamp.seconds*1000).toLocaleDateString('he-IL', { year:'numeric', month:'long', day:'numeric' });
    }

    const lessonDiv = document.createElement('div');
    lessonDiv.className = 'lesson-card';
    lessonDiv.dataset.id = data.id;

    lessonDiv.innerHTML = `
      <img src="${videoID ? `https://img.youtube.com/vi/${videoID}/hqdefault.jpg` : 'https://via.placeholder.com/320x180?text=No+Image'}" alt="${data.title || ""}">
      <div class="lesson-meta">
        <h3>${data.title || ""}</h3>
        <p><strong>הרב:</strong> ${data.rabbi || ""}</p>
        <p><strong>קטגוריה:</strong> ${data.category || "לא סווג"}</p>
        <p><strong>תאריך:</strong> ${dateStr}</p>
        <div class="lesson-actions">
          ${videoID ? `<button class="watch-btn" data-id="${data.id}">צפייה</button>` : ""}
          ${data.summary ? `<button class="summary-btn" data-id="${data.id}">הצגת סיכום</button>` : ""}
        </div>
      </div>
    `;
    container.appendChild(lessonDiv);
  });
}

/* === פתיחת וידאו/סיכום בכרטיס === */
container.addEventListener('click', (e) => {
  const id = e.target.dataset?.id;
  if (e.target.classList.contains('watch-btn')) {
    const lesson = allLessons.find(l => l.id === id);
    const videoID = getYouTubeId(lesson?.youtube);
    if (videoID) { modalVideo.src = `https://www.youtube.com/embed/${videoID}`; modal.classList.add('show'); modal.setAttribute('aria-hidden', 'false'); }
  }
  if (e.target.classList.contains('summary-btn')) {
    const lesson = allLessons.find(l => l.id === id);
    if (lesson?.summary) { summaryContent.innerHTML = lesson.summary; summaryModal.classList.add('show'); summaryModal.setAttribute('aria-hidden','false'); }
  }
});

/* קליק על הכרטיס עצמו פותח וידאו */
container.addEventListener('click', (e) => {
  if (e.target.closest('button')) return;
  const card = e.target.closest('.lesson-card');
  if (!card) return;
  const lesson = allLessons.find(l => l.id === card.dataset.id);
  const videoID = getYouTubeId(lesson?.youtube);
  if (videoID) { modalVideo.src = `https://www.youtube.com/embed/${videoID}`; modal.classList.add('show'); modal.setAttribute('aria-hidden', 'false'); }
});

/* === החלק החשוב: סינון + חיפוש חכם === */
function filterAndSortLessons() {
  const rawSearch = searchInput.value || "";
  const searchTerm = normalizeHebrewBasic(rawSearch);
  const category = categorySelect.value;

  let list;

  // אם יש טקסט חיפוש – משתמשים ב-Fuse
  if (searchTerm.length >= 1 && fuse) {
    list = fuse.search(searchTerm).map(r => r.item);
  } else {
    // בלי חיפוש – כל השיעורים, ממוינים לפי תאריך חדש->ישן
    list = [...allLessons].sort((a,b)=> (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
  }

  // סינון לפי קטגוריה (אם נבחרה)
  if (category) {
    list = list.filter(l => (l.category || "") === category);
  }

  // אם חיפשנו – כבר קיבלנו דירוג רלוונטיות. נשמור עליו,
  // אבל נעדיף תאריך כשיש שוויון גס.
  if (searchTerm.length >= 1) {
    list = list.map((item, idx) => ({ item, idx }))
      .sort((a, b) => {
        // קודם כל: אם לשניהם יש תאריך – חדש קודם
        const ta = a.item.timestamp?.seconds || 0;
        const tb = b.item.timestamp?.seconds || 0;
        if (tb !== ta) return tb - ta;
        // אחרת – סדר החיפוש המקורי
        return a.idx - b.idx;
      })
      .map(x => x.item);
  }

  renderLessons(list);
}

/* האזנה לשינויים בשדות החיפוש/קטגוריה */
searchInput.addEventListener('input', filterAndSortLessons);
categorySelect.addEventListener('change', filterAndSortLessons);

/* מודאלים – סגירה */
closeModal.addEventListener('click', () => { modalVideo.src=''; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); });
closeSummaryModal.addEventListener('click', () => { summaryModal.classList.remove('show'); summaryModal.setAttribute('aria-hidden','true'); });
modal.addEventListener('click', (e)=>{ if(e.target===modal){ modalVideo.src=''; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }});
summaryModal.addEventListener('click', (e)=>{ if(e.target===summaryModal){ summaryModal.classList.remove('show'); summaryModal.setAttribute('aria-hidden','true'); }});
</script>

<footer>
  <div class="wave"></div>
  <p>כל הזכויות שמורות © 2025 מרכז שיעורי הר הבית | לפרטים וליצירת קשר: 055-9962656 | glasser.avraham@gmail.com</p>
</footer>

<style>
  footer {
    position: relative;
    background: #CD853F
; /* צבע רקע של הפוטר */
    color: white;
    text-align: center;
    padding: 3px 3px 3px 3px;
  }
: cover;
  }
</style>




<!-- מודאל תמונה בעת כניסה -->
<div id="entry-modal" class="entry-modal">
  <img src="stop.png" alt="אזהרה" class="entry-modal-img">
</div>

<style>
/* שכבת הרקע המטושש */
.entry-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  backdrop-filter: blur(6px); /* טשטוש */
  background: rgba(0, 0, 0, 0.5); /* כהות */
  display: flex;
  justify-content: center;
  align-items: flex-start; /* תמונה קרובה לראש הדף */
  padding-top: 40px;
  z-index: 2000;
}

/* התמונה עצמה */
.entry-modal-img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}

/* אנימציית הופעה */
.entry-modal {
  animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>

<script>
// סגירת המודאל בלחיצה בכל מקום במסך
document.getElementById("entry-modal").addEventListener("click", function() {
  this.remove();
});
</script>






</body>
</html>
